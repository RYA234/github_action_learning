name: Branch Log Management

on:
  create:
  delete:
  pull_request:
    types: [closed]
  workflow_dispatch:  # 手動実行（レポート再生成）

jobs:
  update-wiki:
    # タグイベントとマージされていないPRクローズは除外
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'create' && github.event.ref_type == 'branch') ||
      (github.event_name == 'delete' && github.event.ref_type == 'branch') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Clone Wiki repository
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git wiki
          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Initialize history file
        run: |
          cd wiki
          if [ ! -f branch-history.json ]; then
            echo "[]" > branch-history.json
          fi

      - name: Log branch event
        if: github.event_name == 'create' || github.event_name == 'delete'
        env:
          EVENT_NAME: ${{ github.event_name }}
          REF: ${{ github.event.ref }}
          ACTOR: ${{ github.actor }}
        run: |
          cd wiki
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          NEW_ENTRY=$(cat <<EOF
          {
            "event": "$EVENT_NAME",
            "branch": "$REF",
            "actor": "$ACTOR",
            "timestamp": "$TIMESTAMP",
            "commit_sha": "${{ github.sha }}"
          }
          EOF
          )

          jq --argjson entry "$NEW_ENTRY" '. += [$entry]' branch-history.json > tmp.json
          mv tmp.json branch-history.json
          echo "Branch event logged: $EVENT_NAME - $REF by $ACTOR"

      - name: Log merge event
        if: github.event_name == 'pull_request'
        run: |
          cd wiki
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          NEW_ENTRY=$(cat <<EOF
          {
            "event": "merge",
            "branch": "${{ github.event.pull_request.head.ref }}",
            "base_branch": "${{ github.event.pull_request.base.ref }}",
            "actor": "${{ github.actor }}",
            "timestamp": "$TIMESTAMP",
            "pr_number": ${{ github.event.pull_request.number }},
            "commit_sha": "${{ github.event.pull_request.merge_commit_sha }}"
          }
          EOF
          )

          jq --argjson entry "$NEW_ENTRY" '. += [$entry]' branch-history.json > tmp.json
          mv tmp.json branch-history.json
          echo "Merge event logged: ${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}"

      - name: Generate report
        run: |
          cd wiki
          if [ "$(jq 'length' branch-history.json)" -eq 0 ]; then
            echo "No branch history found"
            exit 0
          fi

          # 統計情報の集計
          TOTAL_EVENTS=$(jq 'length' branch-history.json)
          CREATED_COUNT=$(jq '[.[] | select(.event == "create")] | length' branch-history.json)
          DELETED_COUNT=$(jq '[.[] | select(.event == "delete")] | length' branch-history.json)
          MERGED_COUNT=$(jq '[.[] | select(.event == "merge")] | length' branch-history.json)
          WEEK_AGO=$(date -u -d '7 days ago' +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -v-7d +"%Y-%m-%dT%H:%M:%SZ")
          RECENT_EVENTS=$(jq --arg week_ago "$WEEK_AGO" '[.[] | select(.timestamp > $week_ago)] | length' branch-history.json)

          # レポートをMarkdown形式で作成
          cat > Branch-Activity-Report.md <<EOF
          # Branch Activity Report

          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Summary

          | 項目 | 件数 |
          |------|------|
          | Total events logged | $TOTAL_EVENTS |
          | Branches created | $CREATED_COUNT |
          | Branches deleted | $DELETED_COUNT |
          | Branches merged | $MERGED_COUNT |
          | Recent activity (last 7 days) | $RECENT_EVENTS |

          ## Recent Events (Last 10)

          | Event | Branch | Actor | Timestamp |
          |-------|--------|-------|-----------|
          EOF

          jq -r '.[-10:] | reverse | .[] | "| \(.event) | \(.branch) | @\(.actor) | \(.timestamp) |"' branch-history.json >> Branch-Activity-Report.md

          cat >> Branch-Activity-Report.md <<EOF

          ## Top Contributors

          | Actor | Events |
          |-------|--------|
          EOF

          jq -r 'group_by(.actor) | map({actor: .[0].actor, count: length}) | sort_by(.count) | reverse | .[] | "| @\(.actor) | \(.count) |"' branch-history.json >> Branch-Activity-Report.md

      - name: Push to Wiki
        run: |
          cd wiki
          git add branch-history.json Branch-Activity-Report.md
          git commit -m "Update branch log - $(date -u +"%Y-%m-%d %H:%M")" || echo "No changes to commit"
          git push
